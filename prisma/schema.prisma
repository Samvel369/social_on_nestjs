// ---------- –∏—Å—Ç–æ—á–Ω–∏–∫–∏/–≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä—ã ----------
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// ---------- –º–æ–¥–µ–ª–∏ ----------

model User {
  id           Int      @id @default(autoincrement())
  username     String   @unique
  email        String   @unique
  password     String
  firstName    String?
  lastName     String?
  lastActive   DateTime @default(now())
  avatarUrl    String   @default("/static/default-avatar.png")
  birthdate    DateTime?
  status       String   @default("–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤—É—é –≤—Å–µ—Ö!")
  about        String   @default("–ü–æ–∫–∞ –Ω–∏—á–µ–≥–æ –æ —Å–µ–±–µ –Ω–µ —Ä–∞—Å—Å–∫–∞–∑–∞–ª.")

  // –°–≤—è–∑–∏
  actions Action[]
  marks   ActionMark[]

  ignored    IgnoredUser[] @relation("ignorer")
  ignoredBy  IgnoredUser[] @relation("ignored")

  sentRequests     FriendRequest[] @relation("sender")
  receivedRequests FriendRequest[] @relation("receiver")

  subscribers   Subscriber[] @relation("owner")
  subscriptions Subscriber[] @relation("subscriber")

  potentialViews PotentialFriendView[] @relation("pfv_viewer")
  viewedBy       PotentialFriendView[] @relation("pfv_user")

  sentMessages     Message[] @relation("sent_messages")
  receivedMessages Message[] @relation("received_messages")
  
  // –†–µ–∞–∫—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  reactions        MessageReaction[]
}

model Action {
  id             Int      @id @default(autoincrement())
  userId         Int
  publishCount   Int      @default(0)
  text           String   @db.VarChar(255)
  normalizedText String   @default("") @db.VarChar(512)
  isPublished    Boolean  @default(false)
  isDaily        Boolean  @default(false)
  createdAt      DateTime @default(now())
  expiresAt      DateTime?
  
  // üî• CASCADE: –£–¥–∞–ª—è–µ–º —é–∑–µ—Ä–∞ -> —É–¥–∞–ª—è—é—Ç—Å—è –µ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è
  user  User? @relation(fields: [userId], references: [id], onDelete: Cascade)
  marks ActionMark[] 

  @@index([normalizedText])
  @@index([userId, isPublished, id], map: "idx_user_isPublished_id")
  @@index([userId, isPublished, normalizedText], map: "idx_user_isPublished_norm")
  @@index([isPublished, normalizedText], map: "idx_isPublished_norm")
  @@index([isPublished, expiresAt], map: "idx_isPublished_expires")
}

model ActionMark {
  id        Int      @id @default(autoincrement())
  userId    Int
  actionId  Int
  timestamp DateTime @default(now())

  // üî• CASCADE
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  action Action @relation(fields: [actionId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([actionId])
}

model FriendRequest {
  id         Int                 @id @default(autoincrement())
  senderId   Int
  receiverId Int
  timestamp  DateTime            @default(now())
  status     FriendRequestStatus @default(PENDING)

  // üî• CASCADE
  sender   User @relation("sender", fields: [senderId], references: [id], onDelete: Cascade)
  receiver User @relation("receiver", fields: [receiverId], references: [id], onDelete: Cascade)

  @@index([senderId])
  @@index([receiverId])
}

model Subscriber {
  id           Int @id @default(autoincrement())
  subscriberId Int
  ownerId      Int

  // üî• CASCADE
  subscriber User @relation("subscriber", fields: [subscriberId], references: [id], onDelete: Cascade)
  owner      User @relation("owner", fields: [ownerId], references: [id], onDelete: Cascade)

  @@unique([subscriberId, ownerId])
  @@index([subscriberId])
  @@index([ownerId])
}

model PotentialFriendView {
  id        Int      @id @default(autoincrement())
  viewerId  Int
  userId    Int
  timestamp DateTime @default(now())

  // üî• CASCADE
  viewer User @relation("pfv_viewer", fields: [viewerId], references: [id], onDelete: Cascade)
  user   User @relation("pfv_user", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([viewerId, userId], name: "viewerId_userId")
  @@index([viewerId])
  @@index([userId])
}

model IgnoredUser {
  ignorerId Int
  ignoredId Int

  // üî• CASCADE
  ignorer User @relation("ignorer", fields: [ignorerId], references: [id], onDelete: Cascade)
  ignored User @relation("ignored", fields: [ignoredId], references: [id], onDelete: Cascade)

  @@id([ignorerId, ignoredId])
  @@index([ignorerId])
  @@index([ignoredId])
}

enum FriendRequestStatus {
  PENDING
  ACCEPTED
  DECLINED
}

model Message {
  id                 Int      @id @default(autoincrement())
  content            String
  senderId           Int
  receiverId         Int
  createdAt          DateTime @default(now())
  isRead             Boolean  @default(false)
  isEdited           Boolean  @default(false)
  deletedForReceiver Boolean  @default(false)

  // –°–≤—è–∑–∏
  sender   User @relation("sent_messages", fields: [senderId], references: [id], onDelete: Cascade)
  receiver User @relation("received_messages", fields: [receiverId], references: [id], onDelete: Cascade)
  
  // –†–µ–∞–∫—Ü–∏–∏
  reactions MessageReaction[]
}

model MessageReaction {
  id        Int      @id @default(autoincrement())
  messageId Int
  userId    Int
  emoji     String 
  createdAt DateTime @default(now())

  message Message @relation(fields: [messageId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([messageId, userId, emoji])
}