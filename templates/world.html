{% extends "base.html" %}
{% block title %}Наш мир{% endblock %}

{% block content %}
<div style="text-align: center; margin-bottom: 24px;">
  <h1 style="font-size: 32px; margin-bottom: 8px;">
    <i class="fa-solid fa-globe"></i>
    Наш Мир
  </h1>
  <p style="color: var(--text-secondary); font-size: 15px; max-width: 650px; margin: 0 auto;">
    Что происходит прямо сейчас? Отметьте своё действие и найдите тех, кто переживает то же самое.
  </p>
</div>

<div class="tabs-container">
  <!-- Заголовки вкладок -->
  <div class="tabs-header">
    <button class="tab-button active" data-tab="top10">
      <i class="fa-solid fa-trophy"></i>
      <span>Топ 10</span>
    </button>
    <button class="tab-button" data-tab="daily">
      <i class="fa-solid fa-clock"></i>
      <span>Сейчас происходит</span>
    </button>
    <button class="tab-button" data-tab="happening">
      <i class="fa-solid fa-fire"></i>
      <span>Создать событие</span>
    </button>
    <button class="tab-button" data-tab="events">
      <i class="fa-solid fa-list"></i>
      <span>События</span>
    </button>
  </div>

  <!-- Вкладка: Топ 10 -->
  <div class="tab-content active" id="tab-top10">
    <div
      style="background: var(--bg-card); padding: 28px; border-radius: var(--radius-lg); box-shadow: var(--shadow-md); border: 2px solid var(--border-color);">
      <h3 style="margin-bottom: 20px;">
        <i class="fa-solid fa-trophy" style="color: var(--accent-pulse);"></i>
        Топ 10 действий за последнюю минуту
      </h3>

      <ul id="top-actions-list" style="list-style: none; padding: 0;">
        <li style="text-align: center; padding: 20px; color: var(--text-secondary);">Загрузка...</li>
      </ul>
    </div>
  </div>

  <script>
    function updateTopActions() {
      // Only fetch if the tab is active
      const top10Tab = document.getElementById('tab-top10');
      if (!top10Tab || !top10Tab.classList.contains('active')) return;

      fetch('/api/actions/get_top_actions', { credentials: 'include' })
        .then(r => r.json())
        .then(data => {
          const list = document.getElementById('top-actions-list');
          if (!list) return;

          if (!Array.isArray(data) || data.length === 0) {
            const currentText = list.textContent?.trim();
            if (currentText !== 'Нет активных действий') {
              list.innerHTML = '<li style="text-align: center; color: var(--text-muted); padding: 20px;">Нет активных действий</li>';
            }
            return;
          }

          const currentContent = list.innerHTML;
          const newContent = data.map((action, idx) => {
            return `<li data-id="${action.id}" style="padding: 12px; margin: 8px 0; background: rgba(255, 255, 255, 0.05); border-radius: var(--radius-sm);">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <a href="/api/actions/action_card/${action.id}" target="_blank" style="flex: 1; text-decoration: none; color: var(--text-primary);">
                  <strong style="color: var(--accent-pulse); margin-right: 8px;">${idx + 1}.</strong> ${action.text}
                </a>
                <span style="font-weight: 700; color: var(--accent-connection); font-size: 16px; min-width: 60px; text-align: right;">
                  ${action.marks ?? 0} <i class="fa-solid fa-user" style="font-size: 12px; opacity: 0.7;"></i>
                </span>
              </div>
            </li>`;
          }).join('');

          if (currentContent !== newContent) {
            list.innerHTML = newContent;
          }
        })
        .catch(() => { });
    }

    // Init & Interval
    document.addEventListener('DOMContentLoaded', () => {
      // Initial check if tab is active by default (it's not, but good practice)
      if (document.getElementById('tab-top10')?.classList.contains('active')) {
        updateTopActions();
      }

      // Polling every second
      setInterval(updateTopActions, 1000);

      // Also trigger update when tab is clicked
      const top10Btn = document.querySelector('button[data-tab="top10"]');
      if (top10Btn) {
        top10Btn.addEventListener('click', () => {
          // Small delay to allow class switch
          setTimeout(updateTopActions, 50);
        });
      }
    });
  </script>

  <!-- Вкладка: Ежедневные -->
  <div class="tab-content" id="tab-daily">
    <div
      style="background: var(--bg-card); padding: 28px; border-radius: var(--radius-lg); box-shadow: var(--shadow-md); border: 2px solid var(--border-color);">
      <h3 style="margin-bottom: 20px;">
        <i class="fa-solid fa-clock" style="color: var(--accent-pulse);"></i>
        Сейчас происходит
      </h3>
      <p style="color: var(--text-secondary); font-size: 13px; margin-bottom: 16px;">
        Каждая отметка живёт ровно 1 минуту с момента постановки. Отметьтесь и увидьте, кто делает то же самое прямо
        сейчас.
      </p>

      <input type="text" id="daily-actions-search" placeholder="Поиск действия..."
        style="width: 100%; padding: 10px 14px; margin-bottom: 16px; font-size: 14px; border: 2px solid var(--border-color); border-radius: var(--radius-sm); box-sizing: border-box;" />

      {% if daily_actions and daily_actions.length %}
      <div id="daily-actions-scroll" style="max-height: 420px; overflow-y: auto;">
        <ul id="daily-actions-list" style="list-style: none; padding: 0; margin: 0;">
          {% for action in daily_actions %}
          <li data-daily-id="{{ action.id }}" class="daily-action-row"
            style="padding: 12px 16px; margin: 12px 0; background: rgba(243, 156, 18, 0.05); border-left: 4px solid var(--accent-pulse); border-radius: var(--radius-sm); transition: all 0.3s ease;">
            <div
              style="display: flex; justify-content: space-between; align-items: center; gap: 16px; flex-wrap: nowrap;">
              <span style="flex: 1; font-weight: 600; min-width: 0;">{{ action.text }}</span>
              <div style="display: flex; align-items: center; gap: 12px; flex-shrink: 0;">
                <span style="font-weight: 700; color: var(--accent-connection); white-space: nowrap; font-size: 18px;">
                  <span id="daily-counter-{{ action.id }}">{{ action.count }}</span>
                </span>
                <button type="button" class="daily-mark-btn" data-daily-id="{{ action.id }}"
                  style="width: auto; padding: 6px 12px; white-space: nowrap;">
                  <i class="fa-solid fa-check"></i> Отметиться
                </button>
              </div>
            </div>
          </li>
          {% endfor %}
        </ul>
      </div>
      {% else %}
      <p style="color: var(--text-muted); text-align: center; padding: 40px;">Нет ежедневных действий</p>
      {% endif %}
    </div>
  </div>

  <!-- Вкладка: Сейчас происходит (Создание) -->
  <div class="tab-content" id="tab-happening">
    <div style="display: grid; grid-template-columns: 70fr 30fr; gap: 24px;">

      <!-- Колонка: Опубликованные (70%) -->
      <div
        style="background: var(--bg-card); padding: 28px; border-radius: var(--radius-lg); box-shadow: var(--shadow-md); border: 2px solid var(--border-color);">
        <h3 style="margin-bottom: 20px;">
          <i class="fa-solid fa-fire" style="color: var(--accent-moment);"></i>
          Создать событие
        </h3>
        <ul id="published-actions" style="list-style: none; padding: 0;">
          {% for action in published %}
          <li data-id="{{ action.id }}"
            style="padding: 16px; margin: 12px 0; background: rgba(231, 76, 60, 0.05); border-left: 4px solid var(--accent-moment); border-radius: var(--radius-sm); transition: all 0.3s ease;">
            <div
              style="display: flex; justify-content: space-between; align-items: center; gap: 16px; margin-bottom: 12px;">
              <a href="/api/actions/action_card/{{ action.id }}" target="_blank" style="flex: 1; font-weight: 600;">
                {{ action.text }}
              </a>
              <span style="font-weight: 700; color: var(--accent-connection); white-space: nowrap; font-size: 18px;">
                <span id="counter-{{ action.id }}">0</span> чел.
              </span>
            </div>
            <button type="button" class="published-mark-btn" data-action-id="{{ action.id }}" style="width: 100%;">
              <i class="fa-solid fa-check"></i> Отметиться
            </button>
            <div id="message-{{ action.id }}" class="msg" style="margin-top: 8px; font-size: 14px;"></div>
            <span id="cooldown-{{ action.id }}" style="display:none;"></span>
          </li>
          {% endfor %}
        </ul>
      </div>

      <!-- Колонка: Создать действие (30%) -->
      <div
        style="background: var(--bg-card); padding: 24px; border-radius: var(--radius-lg); box-shadow: var(--shadow-md); border: 2px solid var(--border-color);">
        <h3 style="margin-bottom: 16px; font-size: 18px;">
          <i class="fa-solid fa-plus-circle" style="color: var(--accent-connection);"></i>
          Создать
        </h3>

        <!-- Создание черновика -->
        <form id="world-create-form" method="post" action="/api/events/new" style="gap: 12px; margin-bottom: 20px;">
          <input type="text" name="text" placeholder="Ваше действие..." style="font-size: 14px;" />
          <button type="button" id="world-create-btn" style="width: 100%; font-size: 14px;">
            <i class="fa-solid fa-plus"></i> Создать
          </button>
        </form>

        {% set _drafts = drafts or my_created %}
        {% if _drafts and _drafts.length %}
        <h4 style="margin-top: 24px; margin-bottom: 12px; color: var(--text-secondary); font-size: 14px;">Созданные</h4>

        <div id="created-actions">
          {% for action in _drafts %}
          <div class="draft-action" data-id="{{ action.id }}" style="padding: 12px; margin-bottom: 12px;">
            <div
              style="display:flex; justify-content:space-between; align-items:flex-start; gap: 8px; margin-bottom: 12px;">
              <p style="margin:0; flex: 1; font-size: 13px;">
                <a href="/api/actions/action_card/{{ action.id }}" target="_blank">{{ action.text }}</a>
              </p>
              <form method="post" action="/api/events/delete/{{ action.id }}" style="margin: 0;">
                <button type="submit" onclick="return confirm('Удалить?')" class="btn-danger"
                  style="padding: 6px 10px; font-size: 12px;">
                  <i class="fa-solid fa-trash"></i>
                </button>
              </form>
            </div>

            <!-- Публикация черновика -->
            <form class="world-publish" method="post" action="/api/events/publish" style="gap: 8px;">
              <input type="hidden" name="id" value="{{ action.id }}">
              <select name="duration" id="duration-{{ action.id }}" style="flex: 1; font-size: 13px; padding: 8px;">
                <option value="10">10 мин</option>
                <option value="30">30 мин</option>
                <option value="60">1 час</option>
              </select>
              <button type="button" class="publish-btn btn-success" data-id="{{ action.id }}"
                style="flex: 1; font-size: 12px; padding: 8px 12px;">
                <i class="fa-solid fa-rocket"></i> Опубликовать
              </button>
            </form>
          </div>
          {% endfor %}
        </div>
        {% endif %}
      </div>

    </div>
  </div>
  <!-- Вкладка: События -->
  <div class="tab-content" id="tab-events">
    <div
      style="background: var(--bg-card); padding: 28px; border-radius: var(--radius-lg); box-shadow: var(--shadow-md); border: 2px solid var(--border-color); margin-bottom: 32px;">
      <h3>
        <i class="fa-solid fa-plus-circle" style="color: var(--accent-connection);"></i>
        Добавить новое действие
      </h3>
      <form id="create-action-form" data-ajax="1" style="display: flex; gap: 12px; margin-top: 20px;">
        <input type="text" id="new-action-text" name="text" placeholder="Что вы делаете прямо сейчас?" required
          style="flex: 1;" />
        <button type="submit" class="btn-success">
          <i class="fa-solid fa-paper-plane"></i>
          Создать
        </button>
      </form>
    </div>

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
      <!-- Черновики -->
      <div>
        <h3 style="margin-bottom: 20px;">
          <i class="fa-solid fa-file" style="color: var(--accent-pulse);"></i>
          Черновики
        </h3>
        <div id="drafts-list">
          {% if drafts and drafts.length %}
          {% for d in drafts %}
          <div class="action-item draft-action" data-id="{{ d.id }}"
            style="background: var(--bg-card); padding: 12px; border-radius: var(--radius-md); border: 2px solid var(--border-color); margin-bottom: 10px; box-shadow: var(--shadow-sm);">
            <div style="display: flex; gap: 8px; align-items: center;">
              <a href="/api/actions/action_card/{{ d.id }}"
                style="flex: 1; font-weight: 600; font-size: 14px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">{{
                d.text }}</a>

              <select class="duration" style="width: 95px; font-size: 12px; padding: 6px;">
                <option value="10">10 мин</option>
                <option value="30">30 мин</option>
                <option value="60">1 час</option>
              </select>

              <button type="button" class="publish-btn btn-success"
                style="font-size: 11px; padding: 6px 12px; white-space: nowrap;">
                <i class="fa-solid fa-rocket"></i> Опубликовать
              </button>

              <button type="button" class="delete-btn btn-danger" style="padding: 6px 10px; font-size: 11px;">
                <i class="fa-solid fa-trash"></i>
              </button>
            </div>
          </div>
          {% endfor %}
          {% else %}
          <p id="no-drafts" style="text-align: center; color: var(--text-muted); padding: 40px;">Нет черновиков</p>
          {% endif %}
        </div>
      </div>

      <!-- Опубликованные -->
      <div>
        <h3 style="margin-bottom: 20px;">
          <i class="fa-solid fa-fire" style="color: var(--accent-moment);"></i>
          Опубликованные действия
        </h3>
        <div id="published-list">
          {% if published and published.length %}
          {% for a in published %}
          <div class="action-item" data-id="{{ a.id }}"
            style="background: var(--bg-card); padding: 12px; border-radius: var(--radius-md); border: 2px solid var(--border-color); margin-bottom: 10px; box-shadow: var(--shadow-sm);">
            <div style="display: flex; gap: 8px; align-items: center; margin-bottom: 6px;">
              <a href="/api/actions/action_card/{{ a.id }}"
                style="flex: 1; font-weight: 600; font-size: 14px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">{{
                a.text }}</a>

              <select class="republish-duration" style="width: 95px; font-size: 12px; padding: 6px;">
                <option value="10">+10м</option>
                <option value="30">+30м</option>
                <option value="60">+1ч</option>
              </select>

              <button type="button" class="republish-btn btn-success"
                style="font-size: 11px; padding: 6px 12px; white-space: nowrap;">
                <i class="fa-solid fa-plus"></i> Продлить
              </button>

              <button type="button" class="delete-btn btn-danger" style="padding: 6px 10px; font-size: 11px;">
                <i class="fa-solid fa-trash"></i>
              </button>
            </div>

            <small style="color: var(--text-secondary); display: block; font-size: 10px; padding-left: 2px;">
              <i class="fa-solid fa-clock"></i> Действует до: <span class="expires-iso">{{ a.expiresAt or '—' }}</span>
              {% if a.expiresAt %}
              (осталось: <span class="expires-left" data-expires="{{ a.expiresAt }}"></span>)
              {% endif %}
            </small>
          </div>
          {% endfor %}
          {% else %}
          <p id="no-published" style="text-align: center; color: var(--text-muted); padding: 40px;">Нет опубликованных
            действий</p>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<script src="/static/js/world.js"></script>
<script src="/static/js/events.js"></script>
<script>
  // Вкладки с сохранением состояния
  const worldTabButtons = document.querySelectorAll('.tab-button');
  const worldTabContents = document.querySelectorAll('.tab-content');

  function activateTab(tabId) {
    if (!tabId) return;

    // Deactivate all
    worldTabButtons.forEach(btn => btn.classList.remove('active'));
    worldTabContents.forEach(content => content.classList.remove('active'));

    // Activate target
    const targetBtn = document.querySelector(`.tab-button[data-tab="${tabId}"]`);
    const targetContent = document.getElementById(`tab-${tabId}`);

    if (targetBtn && targetContent) {
      targetBtn.classList.add('active');
      targetContent.classList.add('active');
      localStorage.setItem('world_active_tab', tabId);

      // Trigger specific updates
      if (tabId === 'top10') updateTopActions();
    }
  }

  // Click handlers
  worldTabButtons.forEach(button => {
    button.addEventListener('click', () => {
      const tabId = button.getAttribute('data-tab');
      activateTab(tabId);
    });
  });

  // Restore state on load
  document.addEventListener('DOMContentLoaded', () => {
    const savedTab = localStorage.getItem('world_active_tab');
    if (savedTab) {
      activateTab(savedTab);
    } else {
      // Default to top10
      activateTab('top10');
    }
  });
</script>
{% endblock %}