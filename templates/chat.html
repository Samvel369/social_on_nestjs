{% extends 'base.html' %}

{% block title %}–°–æ–æ–±—â–µ–Ω–∏—è{% endblock %}

{% block content %}
<style>
  /* –°—Ç–∞—Ä—ã–µ —Å—Ç–∏–ª–∏ –æ—Å—Ç–∞–≤–ª—è–µ–º... */
  .chat-container { display: flex; height: calc(100vh - 100px); background: #fff; border: 1px solid #ddd; border-radius: 8px; overflow: hidden; }
  .chat-sidebar { width: 250px; background: #f7f7f7; border-right: 1px solid #ddd; display: flex; flex-direction: column; }
  .chat-sidebar h4 { padding: 15px; margin: 0; background: #eee; border-bottom: 1px solid #ddd; }
  .contact-list { list-style: none; padding: 0; margin: 0; overflow-y: auto; flex: 1; }
  .contact-item { display: flex; align-items: center; gap: 10px; padding: 10px 15px; cursor: pointer; border-bottom: 1px solid #eee; transition: background 0.2s; position: relative; }
  .contact-item:hover { background: #e0e0e0; }
  .contact-item.active { background: #d0e0ff; }
  .contact-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
  .contact-badge { background: #28a745; color: white; border-radius: 12px; padding: 2px 8px; font-size: 11px; font-weight: bold; margin-left: auto; }
  .typing-indicator { font-size: 11px; color: #007bff; font-style: italic; display: none; margin-top: 2px; }
  .typing-dots::after { content: '...'; animation: dots 1.5s steps(4, end) infinite; }
  @keyframes dots { 0%, 20% { content: ''; } 40% { content: '.'; } 60% { content: '..'; } 80%, 100% { content: '...'; } }
  .chat-main { flex: 1; display: flex; flex-direction: column; background: #fff; }
  .chat-header { padding: 15px; border-bottom: 1px solid #ddd; background: #fcfcfc; display: flex; align-items: center; gap: 10px; }
  .messages-area { flex: 1; padding: 20px; overflow-y: auto; background: #fdfdfd; display: flex; flex-direction: column; gap: 10px; }

  .chat-input-area { padding: 15px; border-top: 1px solid #ddd; background: #f7f7f7; display: flex; gap: 10px; }
  .chat-input-area input { flex: 1; padding: 10px; border-radius: 20px; border: 1px solid #ccc; outline: none; }
  .chat-input-area button { padding: 10px 20px; border-radius: 20px; border: none; background: #28a745; color: white; cursor: pointer; }
  .chat-input-area button:hover { background: #218838; }
  .cancel-edit-btn { background: #dc3545 !important; display: none; }
  .no-chat-selected { flex: 1; display: flex; align-items: center; justify-content: center; color: #999; }

  /* üî• –û–ë–ù–û–í–õ–ï–ù–ù–´–ï –°–¢–ò–õ–ò –°–û–û–ë–©–ï–ù–ò–ô üî• */
  .msg-container {
    display: flex;
    flex-direction: column;
    max-width: 70%;
    position: relative;
    margin-bottom: 5px;
  }
  .msg-container.mine { align-self: flex-end; align-items: flex-end; }
  .msg-container.theirs { align-self: flex-start; align-items: flex-start; }

  .msg {
    padding: 10px 15px;
    border-radius: 12px;
    font-size: 14px;
    line-height: 1.4;
    word-wrap: break-word;
    position: relative;
    /* –£–±—Ä–∞–ª–∏ cursor: context-menu, —Ç–µ–ø–µ—Ä—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É */
  }
  .msg.mine { background: #007bff; color: white; border-bottom-right-radius: 2px; }
  .msg.theirs { background: #e9ecef; color: black; border-bottom-left-radius: 2px; }

  /* –ö–Ω–æ–ø–∫–∞ "–¢—Ä–∏ —Ç–æ—á–∫–∏" (Menu Toggle) */
  .msg-menu-btn {
    position: absolute;
    top: 5px;
    right: 5px;
    color: inherit;
    opacity: 0; /* –°–∫—Ä—ã—Ç–∞ */
    cursor: pointer;
    font-size: 16px;
    line-height: 10px;
    padding: 2px 5px;
    background: rgba(255,255,255,0.2);
    border-radius: 4px;
    transition: opacity 0.2s;
  }
  .msg:hover .msg-menu-btn { opacity: 0.7; }
  .msg-menu-btn:hover { opacity: 1 !important; background: rgba(255,255,255,0.4); }

  .msg-time { font-size: 10px; opacity: 0.7; margin-top: 5px; text-align: right; display: block; }
  .msg-edited { font-size: 10px; font-style: italic; opacity: 0.7; margin-left: 5px; }

  /* üî• –°–¢–ò–õ–ò –†–ï–ê–ö–¶–ò–ô üî• */
  .reactions-row {
    display: flex;
    gap: 4px;
    margin-top: -5px; /* –ß—É—Ç—å –Ω–∞–µ–∑–∂–∞–µ–º –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–ª–∏ –ø—Ä–∏–∂–∏–º–∞–µ–º—Å—è */
    z-index: 10;
    padding: 0 5px;
  }
  .reaction-pill {
    background: #fff;
    border: 1px solid #ddd;
    border-radius: 10px;
    padding: 2px 6px;
    font-size: 11px;
    cursor: pointer;
    box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    display: flex;
    align-items: center;
    gap: 3px;
  }
  .reaction-pill.my-reaction {
    background: #e6f0ff;
    border-color: #007bff;
    color: #007bff;
  }

  /* üî• –ö–û–ù–¢–ï–ö–°–¢–ù–û–ï –ú–ï–ù–Æ üî• */
  #context-menu {
    position: fixed; /* Fixed —á—Ç–æ–±—ã –Ω–µ –∑–∞–≤–∏—Å–µ—Ç—å –æ—Ç —Å–∫—Ä–æ–ª–ª–∞ */
    background: white;
    border: 1px solid #ccc;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    border-radius: 8px;
    display: none;
    z-index: 9999;
    width: 180px;
    overflow: hidden;
  }
  #context-menu ul { list-style: none; padding: 0; margin: 0; }
  #context-menu li { padding: 10px 15px; cursor: pointer; font-size: 14px; color: #333; display: flex; align-items: center; gap: 8px; }
  #context-menu li:hover { background: #f5f5f5; }
  #context-menu li.delete-option { color: #dc3545; }
  
  /* –°–µ–∫—Ü–∏—è —Ä–µ–∞–∫—Ü–∏–π –≤ –º–µ–Ω—é */
  .menu-reactions {
    padding: 8px;
    border-bottom: 1px solid #eee;
    display: flex;
    justify-content: space-around;
    background: #fafafa;
  }
  .menu-reaction-btn {
    font-size: 20px;
    cursor: pointer;
    transition: transform 0.1s;
  }
  .menu-reaction-btn:hover { transform: scale(1.3); }

</style>

<div class="chat-container">
  <div class="chat-sidebar">
    <h4>–ö–æ–Ω—Ç–∞–∫—Ç—ã</h4>
    <ul class="contact-list" id="contact-list">
      {% for friend in contacts %}
      <li class="contact-item" 
          data-id="{{ friend.id }}" 
          data-username="{{ friend.username }}" 
          onclick="selectChat({{ friend.id }}, '{{ friend.username }}', '{{ friend.avatar_url }}')">
        <img src="{{ friend.avatar_url }}" class="contact-avatar" alt="ava">
        <div style="display:flex; flex-direction:column; flex:1;">
            <span style="font-weight:bold;">{{ friend.username }}</span>
            <small class="typing-indicator" id="typing-list-{{ friend.id }}">–ø–µ—á–∞—Ç–∞–µ—Ç<span class="typing-dots"></span></small>
        </div>
        <span id="badge-{{ friend.id }}" class="contact-badge" style="display: {{ 'inline-block' if friend.unreadCount > 0 else 'none' }};">{{ friend.unreadCount }}</span>
      </li>
      {% else %}
      <li style="padding:15px; color:#999;">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –¥—Ä—É–∑–µ–π :(</li>
      {% endfor %}
    </ul>
  </div>

  <div class="chat-main">
    <div class="chat-header" id="chat-header" style="display:none;">
      <img src="" id="header-avatar" class="contact-avatar" alt="">
      <div style="display:flex; flex-direction:column;">
          <span id="header-username" style="font-weight:bold;">–ò–º—è</span>
          <small class="typing-indicator" id="typing-header" style="margin-top:0;">–ø–µ—á–∞—Ç–∞–µ—Ç<span class="typing-dots"></span></small>
      </div>
    </div>

    <div class="messages-area" id="messages-area">
      <div class="no-chat-selected">–í—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥–∞ –¥–ª—è –Ω–∞—á–∞–ª–∞ –æ–±—â–µ–Ω–∏—è</div>
    </div>

    <form class="chat-input-area" id="chat-form" style="display:none;">
      <input type="text" id="msg-input" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." autocomplete="off">
      <button type="button" id="cancel-edit-btn" class="cancel-edit-btn">X</button>
      <button type="submit" id="send-btn">Send</button>
    </form>
  </div>
</div>

<div id="context-menu">
  <div class="menu-reactions">
    <span class="menu-reaction-btn" onclick="sendReaction('‚ù§Ô∏è')">‚ù§Ô∏è</span>
    <span class="menu-reaction-btn" onclick="sendReaction('üòÇ')">üòÇ</span>
    <span class="menu-reaction-btn" onclick="sendReaction('üòÆ')">üòÆ</span>
    <span class="menu-reaction-btn" onclick="sendReaction('üò¢')">üò¢</span>
    <span class="menu-reaction-btn" onclick="sendReaction('üëç')">üëç</span>
  </div>
  
  <ul>
    <li id="ctx-reply">‚Ü©Ô∏è –û—Ç–≤–µ—Ç–∏—Ç—å (–°–∫–æ—Ä–æ)</li>
    <li id="ctx-edit">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</li>
    <li id="ctx-delete" class="delete-option">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</li>
  </ul>
</div>

<script src="/static/js/chat.js"></script>
{% endblock %}