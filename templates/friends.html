{% extends 'base.html' %}
{% block content %}

<h1>
  <i class="fa-solid fa-user-group"></i>
  Связи
</h1>

<p style="color: var(--text-secondary); font-size: 18px; margin-bottom: 40px;">
  Найди тех, кто переживает те же моменты, что и ты
</p>

<div class="tabs-container">
  <!-- Заголовки вкладок -->
  <div class="tabs-header">
    <button class="tab-button active" data-tab="possible">
      <i class="fa-solid fa-user-group"></i>
      <span>Возможные</span>
    </button>
    <button class="tab-button" data-tab="incoming">
      <i class="fa-solid fa-inbox"></i>
      <span>Входящие</span>
    </button>
    <button class="tab-button" data-tab="outgoing">
      <i class="fa-solid fa-paper-plane"></i>
      <span>Исходящие</span>
    </button>
    <button class="tab-button" data-tab="friends">
      <i class="fa-solid fa-heart"></i>
      <span>Друзья</span>
    </button>
    <button class="tab-button" data-tab="subscribers">
      <i class="fa-solid fa-user-plus"></i>
      <span>Подписчики</span>
    </button>
    <button class="tab-button" data-tab="subscriptions">
      <i class="fa-solid fa-rss"></i>
      <span>Подписки</span>
    </button>
  </div>

  <!-- Содержимое вкладок -->
  
  <!-- Возможные друзья -->
  <div class="tab-content active" id="tab-possible">
    <div style="display: inline-flex; align-items: center; gap: 16px; padding: 16px 24px; background: var(--bg-card); border-radius: var(--radius-md); border: 1px solid var(--border-color); margin-bottom: 24px;">
      <label style="font-weight: 600; color: var(--text-primary); display: flex; align-items: center; gap: 8px;">
        <i class="fa-solid fa-clock" style="color: var(--accent-pulse);"></i>
        Удалять через:
      </label>
      <select id="cleanup-time" style="min-width: 150px;">
        <option value="1">1 мин (тест)</option>
        <option value="5">5 мин</option>
        <option value="10" {% if keep_minutes == 10 %}selected{% endif %}>10 мин</option>
        <option value="30" {% if keep_minutes == 30 %}selected{% endif %}>30 мин</option>
        <option value="60" {% if keep_minutes == 60 %}selected{% endif %}>1 час</option>
      </select>
    </div>
    <div id="possible-friends-list">
      {% include 'partials/possible_friends.html' %}
    </div>
  </div>

  <!-- Входящие заявки -->
  <div class="tab-content" id="tab-incoming">
    <div id="incoming-requests">
      {% include 'partials/incoming_requests.html' %}
    </div>
  </div>

  <!-- Исходящие заявки -->
  <div class="tab-content" id="tab-outgoing">
    <div id="outgoing-requests">
      {% include 'partials/outgoing_requests.html' %}
    </div>
  </div>

  <!-- Мои друзья -->
  <div class="tab-content" id="tab-friends">
    <div id="friends-list">
      {% include 'partials/friends_list.html' %}
    </div>
  </div>

  <!-- Подписчики -->
  <div class="tab-content" id="tab-subscribers">
    <div id="subscribers-list">
      {% include 'partials/subscribers.html' %}
    </div>
  </div>

  <!-- Подписки -->
  <div class="tab-content" id="tab-subscriptions">
    <div id="subscriptions-list">
      {% include 'partials/subscriptions.html' %}
    </div>
  </div>
</div>

<script src="/static/js/friends.js"></script>

<script>
  // ===== ВКЛАДКИ =====
  const tabButtons = document.querySelectorAll('.tab-button');
  const tabContents = document.querySelectorAll('.tab-content');

  tabButtons.forEach(button => {
    button.addEventListener('click', () => {
      // Убираем active со всех кнопок и контента
      tabButtons.forEach(btn => btn.classList.remove('active'));
      tabContents.forEach(content => content.classList.remove('active'));

      // Добавляем active к выбранной вкладке
      button.classList.add('active');
      const tabId = button.getAttribute('data-tab');
      document.getElementById(`tab-${tabId}`).classList.add('active');
    });
  });

  // ===== АВТОУДАЛЕНИЕ ВОЗМОЖНЫХ ДРУЗЕЙ =====
  function runCleanup() {
    const container = document.getElementById('possible-friends-list');
    const select = document.getElementById('cleanup-time');
    
    if (!container || !select) return;

    const now = new Date().getTime();
    const limitMs = parseInt(select.value) * 60 * 1000;
    const items = container.querySelectorAll('.potential-item');

    items.forEach(item => {
      const createdAtStr = item.getAttribute('data-created');
      if (!createdAtStr) return;

      const createdAt = new Date(createdAtStr).getTime();
      const ageMs = now - createdAt;

      if (ageMs > limitMs) {
        item.style.opacity = '0';
        item.style.transform = 'translateX(-20px)';
        setTimeout(() => item.remove(), 300);
      } else {
        const timeAgoEl = item.querySelector('.time-ago');
        if (timeAgoEl) {
          const minutes = Math.floor(ageMs / 60000);
          const seconds = Math.floor((ageMs % 60000) / 1000);
          timeAgoEl.textContent = minutes > 0 
            ? `${minutes} мин назад` 
            : `${seconds} сек назад`;
        }
      }
    });

    if (items.length > 0 && container.querySelectorAll('.potential-item').length === 0) {
      container.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 40px;">Список очищен.</p>';
    }
  }

  setInterval(runCleanup, 1000);
  runCleanup();
</script>

{% endblock %}
